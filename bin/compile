#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast
set -e

# Debug
set -x

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
GSL_BUILD_DIR="${BUILD_DIR}/vendor/gsl"
APP_VENDOR_DIR="${HOME}/vendor"
PROFILE_PATH="${BUILD_DIR}/.profile.d/gsl.sh"

mkdir -p $(dirname $PROFILE_PATH)
mkdir -p $GSL_BUILD_DIR
mkdir -p $APP_VENDOR_DIR

function set-default-env() {
  echo "export $1=\$$1:${APP_VENDOR_DIR}/$2" >>$PROFILE_PATH
}

echo "-----> Fetching and vendoring gsl"
curl "https://vp-public-dev.s3.us-west-2.amazonaws.com/libraries/gsl-1.14.tar.gz" -s -o - | tar xzf - --strip 1 -C "$GSL_BUILD_DIR"

# FYI we do this and set the export path explicitly because we cannot assume all buildpacks copy this dir over
cp -R "$GSL_BUILD_DIR" "${APP_VENDOR_DIR}/gsl"

set-default-env PATH "gsl/bin"
set-default-env LD_LIBRARY_PATH "gsl/lib"
set-default-env LIBRARY_PATH "gsl/lib"
set-default-env CPATH "gsl/include"

# Export variables for verification within this buildpack
export PATH="${BUILD_DIR}/vendor/gsl/bin:$PATH"
export LD_LIBRARY_PATH="${BUILD_DIR}/vendor/gsl/lib:$LD_LIBRARY_PATH"
export LIBRARY_PATH="${BUILD_DIR}/vendor/gsl/lib:$LIBRARY_PATH"
export CPATH="${BUILD_DIR}/vendor/gsl/include:$CPATH"
export PKG_CONFIG_PATH="${BUILD_DIR}/vendor/gsl/lib/pkgconfig:$PKG_CONFIG_PATH"

echo "-----> GSL buildpack: Installation complete"
echo "       GSL installed to: ${APP_VENDOR_DIR}/gsl"
echo "       Checking for gsl-config: $(which gsl-config || echo 'NOT FOUND')"
echo "       GSL bin dir contents: $(ls -la ${BUILD_DIR}/vendor/gsl/bin/ 2>&1 || echo 'DIR NOT FOUND')"
echo "       Environment will be exported via bin/export for subsequent buildpacks"
